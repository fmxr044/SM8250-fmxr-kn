name: FD-release-munch-builder

on:
  pull_request:
  workflow_dispatch:
    inputs:
      KERNEL_TREE_1:
        description: 'Kernel Tree'
        default: 'https://github.com/re-noroi/kernel_sm8250'
        required: true
      CODENAME:
        description: 'Phone Codename'
        default: 'munch'
        required: true
      ANYKERNEL_URL:
        description: 'AnyKernel Url'
        default: 'https://github.com/re-noroi/anykernel3-test'
        required: false
      CUSTOM_SED:
        description: 'Custom Kernel Version'
        default: '-perf+'
        required: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Install Dependencies
        run: sudo apt install -y flex libncurses6

      - name: Download & Extract Clang
        run: |
          git clone --depth=1 https://github.com/sticpaper/Snapdragon-LLVM-ARM-Compiler-10.0.7-for-Android-NDK clang
          echo "$PWD/clang/bin" >> $GITHUB_PATH

      - name: Set Kernel Environment Variables
        run: |
          echo "KERNEL_TREE=${{ github.event.inputs.KERNEL_TREE_1 }}" >> $GITHUB_ENV
          echo "KERNEL_TREE_BRANCH=next-main" >> $GITHUB_ENV

      - name: Checkout Kernel
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          if [[ "${{ github.event.inputs.KERNEL_TREE_1 }}" == "private" ]]; then
            REPO_URL="https://x-access-token:${GH_PAT}@github.com/re-noroi/FD-private.git"
          else
            REPO_URL="${{ github.event.inputs.KERNEL_TREE_1 }}"
          fi
          git clone --depth=1 --branch "$KERNEL_TREE_BRANCH" "$REPO_URL" kernel_tree

      - name: Kernel Version
        run: |
          cd kernel_tree
          if [[ "${{ github.event.inputs.CUSTOM_SED }}" != "-FakeDreamer" ]]; then
            sed -i \
              's/CONFIG_LOCALVERSION="-FakeDreamer"/CONFIG_LOCALVERSION="${{ github.event.inputs.CUSTOM_SED }}"/' \
              arch/arm64/configs/vendor/munch_defconfig
          fi

      - name: Apply Patches
        run: |
          cd kernel_tree
          bash nextpatch.sh

      - name: Build Kernel
        run: |
          export ARCH=arm64
          export SUBARCH=ARM64
          export KBUILD_BUILD_USER=builder
          export KBUILD_BUILD_HOST=pangu-build
          export KBUILD_BUILD_TIMESTAMP="$(TZ=UTC+8 date)"

          cd kernel_tree

          sed -i 's/CONFIG_LTO_CLANG_FULL=y/CONFIG_LTO_CLANG_FULL=n/' arch/arm64/configs/stock_defconfig
          echo 'CONFIG_KALLSYMS_ALL=y' >> arch/arm64/configs/vendor/munch_defconfig

          make O=out vendor/munch_defconfig
          make O=out CC=clang -j$(nproc) LLVM=1 LLVM_IAS=1

          cp out/arch/arm64/boot/Image.gz ../Image.gz
          cp out/arch/arm64/boot/dtb.img ../munch-dtb.img
          cp out/arch/arm64/boot/dtbo.img ../munch-dtbo.img

      - name: Upload Kernel Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-munch
          path: |
            Image.gz
            munch-dtb.img
            munch-dtbo.img

  package_anykernel:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download Kernel Artifacts
        uses: actions/download-artifact@v4
        with:
          name: kernel-munch
          path: kernel

      - name: Clone AnyKernel3
        run: |
          git clone --recursive --depth=1 \
            ${{ github.event.inputs.ANYKERNEL_URL }} \
            -b munch AnyKernel3

      - name: Move Kernel Files
        run: |
          mv kernel/* AnyKernel3/

      - name: Define ZIP Name
        run: |
          DATE=$(date +%Y%m%d)
          echo "ZIP_NAME=FD-next-${{ github.event.inputs.CODENAME }}-${DATE}" >> $GITHUB_ENV

      - name: Upload Flashable Kernel Zip
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ZIP_NAME }}
          path: |
            AnyKernel3/
            !AnyKernel3/.git
            !AnyKernel3/.github
